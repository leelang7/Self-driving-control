<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>MentorPi Command Center v7.3 (Clean)</title>
    <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros2d@0.9.0/build/ros2d.min.js"></script>

    <style>
        body { margin: 0; background: #0b0e14; color: #fff; font-family: sans-serif; overflow: hidden; }
        #header { height: 50px; background: #1a1f2b; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid #00e5ff; }
        #map { width: 100vw; height: calc(100vh - 130px); background: #1c222d; cursor: crosshair; } 
        .footer { height: 80px; background: #151921; display: flex; align-items: center; justify-content: center; gap: 15px; }
        button { padding: 12px 25px; font-weight: bold; cursor: pointer; border: none; border-radius: 6px; }
        .btn-mode { background: #333; color: #fff; border: 1px solid #555; }
        .btn-mode.active { background: #00e5ff; color: #000; box-shadow: 0 0 10px #00e5ff; }
        .btn-red { background: #ff3d00; color: #fff; }
        #status-msg { color: #00e5ff; font-weight: bold; }
    </style>

    <script type="text/javascript">
        // [ì„¤ì •] ë¡œë´‡ IP
        var ros = new ROSLIB.Ros({ 
            url : 'ws://172.16.10.172:9091' 
        });

        var viewer, gridClient, robotMarker, pathShape;
        var currentMode = 'GOAL'; 
        var isStopping = false;
        var isPanning = false;
        var clickStartX, clickStartY;

        function init() {
            viewer = new ROS2D.Viewer({ divID : 'map', width : window.innerWidth, height : window.innerHeight - 130 });
            
            // 1. ë¹ˆ ê³µê°„ í´ë¦­ ê°ì§€ìš© íˆ¬ëª…íŒ
            var bgHit = new createjs.Shape();
            bgHit.graphics.beginFill("#FFF").drawRect(-10000, -10000, 20000, 20000);
            bgHit.alpha = 0.01; bgHit.cursor = "crosshair";
            viewer.scene.addChild(bgHit); 

            // 2. ë§µ ë¡œë”©
            gridClient = new ROS2D.OccupancyGridClient({
                ros : ros, rootObject : viewer.scene, topic : '/map', continuous : true,
                transportOptions: { queue_size: 1, latch: true } 
            });

            // 3. ê²½ë¡œì„ 
            pathShape = new ROS2D.PathShape({ ros: ros, strokeSize: 0.05, strokeColor: "#00e5ff" });
            pathShape.mouseEnabled = false; 
            viewer.scene.addChild(pathShape);

            // 4. ë¡œë´‡ ë§ˆì»¤ (ì¡°ì¤€ì  ëª¨ì–‘)
            robotMarker = new createjs.Container();
            var radarRing = new createjs.Shape();
            radarRing.graphics.beginFill("rgba(0, 229, 255, 0.4)").drawCircle(0, 0, 10);
            robotMarker.addChild(radarRing);

            var arrowBody = new createjs.Shape();
            arrowBody.graphics.setStrokeStyle(1).beginStroke("#FFF").beginFill("#FF3D00")
                .moveTo(6, 0).lineTo(-4, 4).lineTo(-2, 0).lineTo(-4, -4).closePath();
            robotMarker.addChild(arrowBody);

            robotMarker.scaleX = 0.06; robotMarker.scaleY = 0.06;
            robotMarker.mouseEnabled = false; 
            // ì´ˆê¸°ì—” ìˆ¨ê¹€ (ìœ„ì¹˜ ìˆ˜ì‹ ë˜ë©´ ë³´ì„)
            robotMarker.visible = false; 
            viewer.scene.addChild(robotMarker);

            // 5. [í•µì‹¬ ìˆ˜ì •] TF ëŒ€ì‹  /amcl_pose ì‚¬ìš© (ì¤‘ë³µ í™”ì‚´í‘œ í•´ê²°)
            // /amcl_poseëŠ” Nav2ê°€ ê³„ì‚°í•œ "ì§€ë„ ìƒì˜ ì •í™•í•œ ìœ„ì¹˜" í•˜ë‚˜ë§Œ ì¤ë‹ˆë‹¤.
            var poseTopic = new ROSLIB.Topic({
                ros: ros, name: '/amcl_pose', messageType: 'geometry_msgs/msg/PoseWithCovarianceStamped'
            });

            poseTopic.subscribe(function(msg) {
                // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                robotMarker.x = msg.pose.pose.position.x;
                robotMarker.y = -msg.pose.pose.position.y; // ROS ì¢Œí‘œê³„ ë°˜ì „

                // ë°©í–¥(Quaternion) -> ê°ë„(Yaw) ë³€í™˜
                var q = msg.pose.pose.orientation;
                var yaw = Math.atan2(2 * (q.w * q.z + q.x * q.y), 1 - 2 * (q.y * q.y + q.z * q.z));
                robotMarker.rotation = -yaw * (180 / Math.PI);

                // í™”ë©´ì— í‘œì‹œ
                if (!robotMarker.visible) {
                    robotMarker.visible = true;
                    console.log("ğŸ“ ë¡œë´‡ ìœ„ì¹˜ ìˆ˜ì‹ ë¨!");
                    centerOnRobot();
                }
            });

            // ë§Œì•½ AMCLì´ ì—†ì–´ì„œ ìœ„ì¹˜ê°€ ì•ˆ ëœ° ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë°±ì—… (Odom)
            // ë‹¨, amcl_poseê°€ ë“¤ì–´ì˜¤ë©´ ì´ê±´ ë¬´ì‹œë¨
            var odomTopic = new ROSLIB.Topic({ ros: ros, name: '/odom', messageType: 'nav_msgs/msg/Odometry' });
            odomTopic.subscribe(function(msg) {
                if (robotMarker.visible) return; // ì´ë¯¸ AMCLë¡œ ìœ„ì¹˜ ì¡ì•˜ìœ¼ë©´ ë¬´ì‹œ
                
                robotMarker.x = msg.pose.pose.position.x;
                robotMarker.y = -msg.pose.pose.position.y;
                var q = msg.pose.pose.orientation;
                var yaw = Math.atan2(2 * (q.w * q.z + q.x * q.y), 1 - 2 * (q.y * q.y + q.z * q.z));
                robotMarker.rotation = -yaw * (180 / Math.PI);
                robotMarker.visible = true;
            });

            registerInteraction();

            ros.on('connection', () => { document.getElementById('status-msg').innerText = "ğŸŸ¢ ì‹œìŠ¤í…œ ì˜¨ë¼ì¸"; });
            ros.on('error', (err) => { document.getElementById('status-msg').innerText = "ğŸ”´ ì—°ê²° ì‹¤íŒ¨"; });
            ros.on('close', () => { document.getElementById('status-msg').innerText = "âšª ì—°ê²° ì¢…ë£Œ"; });
        }

        function registerInteraction() {
            var canvas = document.getElementById('map').querySelector('canvas');
            
            // ì¤Œ
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                var zoomFactor = 1.1;
                var local = viewer.scene.globalToLocal(e.offsetX, e.offsetY);
                if (e.deltaY < 0) { viewer.scene.scaleX *= zoomFactor; viewer.scene.scaleY *= zoomFactor; }
                else { viewer.scene.scaleX /= zoomFactor; viewer.scene.scaleY /= zoomFactor; }
                viewer.scene.x = e.offsetX - local.x * viewer.scene.scaleX;
                viewer.scene.y = e.offsetY - local.y * viewer.scene.scaleY;
            });

            // íŒ¬(ì´ë™)
            var startPanX, startPanY;
            canvas.addEventListener('mousedown', function(e) { isPanning = false; startPanX = e.clientX; startPanY = e.clientY; });
            window.addEventListener('mousemove', function(e) {
                if (e.buttons === 1) { 
                    var dx = e.clientX - startPanX, dy = e.clientY - startPanY;
                    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                        isPanning = true; viewer.scene.x += dx; viewer.scene.y += dy;
                        startPanX = e.clientX; startPanY = e.clientY;
                    }
                }
            });

            // í´ë¦­
            viewer.scene.addEventListener('stagemousedown', function(e) { clickStartX = e.stageX; clickStartY = e.stageY; });
            viewer.scene.addEventListener('stagemouseup', function(e) {
                if (isPanning || Math.abs(e.stageX - clickStartX) > 10 || Math.abs(e.stageY - clickStartY) > 10) return;
                var pos = viewer.scene.globalToLocal(e.stageX, e.stageY);
                console.log("ğŸ‘† í´ë¦­:", pos.x.toFixed(2), (-pos.y).toFixed(2));
                if (currentMode === 'GOAL') sendGoal(pos.x, -pos.y);
                else sendInitialPose(pos.x, -pos.y);
            });
        }

        function centerOnRobot() {
            if (!robotMarker.visible) return;
            viewer.scene.x = (viewer.width / 2) - (robotMarker.x * viewer.scene.scaleX);
            viewer.scene.y = (viewer.height / 2) - (-robotMarker.y * viewer.scene.scaleY);
        }

        function sendGoal(x, y) {
            isStopping = false;
            document.getElementById('status-msg').innerText = `ğŸš€ ì´ë™: [${x.toFixed(2)}, ${y.toFixed(2)}]`;
            var topic = new ROSLIB.Topic({ ros : ros, name : '/goal_pose', messageType : 'geometry_msgs/msg/PoseStamped' });
            var msg = new ROSLIB.Message({ header: { frame_id: "map" }, pose: { position: { x: x, y: y, z: 0 }, orientation: { w: 1.0 } } });
            topic.publish(msg);
        }

        function sendInitialPose(x, y) {
            var topic = new ROSLIB.Topic({ ros : ros, name : '/initialpose', messageType : 'geometry_msgs/msg/PoseWithCovarianceStamped' });
            var msg = new ROSLIB.Message({ header: { frame_id: "map" }, pose: { pose: { position: { x: x, y: y, z: 0 }, orientation: { w: 1.0 } }, covariance: [0.25, 0, 0, 0, 0, 0, 0, 0.25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.06] } });
            topic.publish(msg);
            setMode('GOAL');
            document.getElementById('status-msg').innerText = "ğŸ“ ìœ„ì¹˜ ë³´ì • ì™„ë£Œ";
        }

        function stopRobot() {
            isStopping = true; 
            document.getElementById('status-msg').innerText = "ğŸ›‘ ì •ì§€ ì¤‘...";
            if (robotMarker.visible) sendGoal(robotMarker.x, -robotMarker.y);
            var cmdVel = new ROSLIB.Topic({ ros: ros, name: '/cmd_vel', messageType: 'geometry_msgs/msg/Twist' });
            var twist = new ROSLIB.Message({ linear: { x: 0, y: 0, z: 0 }, angular: { x: 0, y: 0, z: 0 } });
            var count = 0;
            var stopInterval = setInterval(() => { cmdVel.publish(twist); count++; if(count > 10) clearInterval(stopInterval); }, 50);
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-goal').className = (mode === 'GOAL' ? 'btn-mode active' : 'btn-mode');
            document.getElementById('btn-pose').className = (mode === 'POSE' ? 'btn-mode active' : 'btn-mode');
        }
    </script>
</head>
<body onload="init()">
    <div id="header">
        <div id="status-msg">ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</div>
        <div>MentorPi Command Center v7.3</div>
    </div>
    <div id="map"></div>
    <div class="footer">
        <button id="btn-goal" class="btn-mode active" onclick="setMode('GOAL')">ğŸ¯ ëª©ì ì§€ ì„¤ì •</button>
        <button id="btn-pose" class="btn-mode" onclick="setMode('POSE')">ğŸ“ ìœ„ì¹˜ ë³´ì •</button>
        <button class="btn-red" onclick="stopRobot()">ğŸ›‘ ì¦‰ì‹œ ì •ì§€</button>
        <button class="btn-mode" onclick="centerOnRobot()">ğŸ” ë‚´ ë¡œë´‡ ì°¾ê¸°</button>
    </div>
</body>
</html>