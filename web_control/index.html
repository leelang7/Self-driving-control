<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>MentorPi Command Center v7.1 (Fixed)</title>
    <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros2d@0.9.0/build/ros2d.min.js"></script>

    <style>
        body { margin: 0; background: #0b0e14; color: #fff; font-family: sans-serif; overflow: hidden; }
        #header { height: 50px; background: #1a1f2b; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid #00e5ff; }
        #map { width: 100vw; height: calc(100vh - 130px); background: #1c222d; cursor: crosshair; } 
        .footer { height: 80px; background: #151921; display: flex; align-items: center; justify-content: center; gap: 15px; }
        button { padding: 12px 25px; font-weight: bold; cursor: pointer; border: none; border-radius: 6px; }
        .btn-mode { background: #333; color: #fff; border: 1px solid #555; }
        .btn-mode.active { background: #00e5ff; color: #000; box-shadow: 0 0 10px #00e5ff; }
        .btn-red { background: #ff3d00; color: #fff; }
        #status-msg { color: #00e5ff; font-weight: bold; }
    </style>

    <script type="text/javascript">
        // [ì„¤ì •] ë¡œë´‡ IP í™•ì¸ í•„ìˆ˜
        var ros = new ROSLIB.Ros({ 
            url : 'ws://172.16.10.172:9091' 
        });

        var viewer, gridClient, robotMarker, pathShape;
        var currentMode = 'GOAL'; 
        var isStopping = false;
        
        // í´ë¦­/ë“œë˜ê·¸ êµ¬ë¶„ìš© ë³€ìˆ˜
        var isPanning = false;
        var clickStartX, clickStartY;

        function init() {
            // 1. ë·°ì–´ ìƒì„±
            viewer = new ROS2D.Viewer({ divID : 'map', width : window.innerWidth, height : window.innerHeight - 130 });
            
            // [í•µì‹¬ ìˆ˜ì •] ë¹ˆ ê³µê°„ í´ë¦­ ê°ì§€ìš© íˆ¬ëª… ë°°ê²½íŒ ìƒì„±
            // ë§µ í¬ê¸°ë³´ë‹¤ í›¨ì”¬ í¬ê²Œ(-500m ~ 500m) ê¹”ì•„ì„œ ì–´ë””ë¥¼ ëˆŒëŸ¬ë„ ê°ì§€ë˜ê²Œ í•¨
            var backgroundHitArea = new createjs.Shape();
            backgroundHitArea.graphics.beginFill("#FFFFFF").drawRect(-10000, -10000, 20000, 20000);
            backgroundHitArea.alpha = 0.01; // ê±°ì˜ íˆ¬ëª…í•¨ (0ìœ¼ë¡œ í•˜ë©´ í´ë¦­ ì•ˆ ë¨¹í˜)
            backgroundHitArea.cursor = "crosshair";
            viewer.scene.addChild(backgroundHitArea); // ê°€ì¥ ë¨¼ì € ì¶”ê°€í•´ì„œ ë°”ë‹¥ì— ê¹ë‹ˆë‹¤.

            // 2. ë§µ í´ë¼ì´ì–¸íŠ¸
            gridClient = new ROS2D.OccupancyGridClient({
                ros : ros,
                rootObject : viewer.scene,
                topic : '/map',
                continuous : true,
                transportOptions: { queue_size: 1, latch: true } 
            });

            // 3. ê²½ë¡œì„  (í´ë¦­ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì„¤ì •)
            pathShape = new ROS2D.PathShape({ ros: ros, strokeSize: 0.05, strokeColor: "#00e5ff" });
            pathShape.mouseEnabled = false; 
            viewer.scene.addChild(pathShape);

            // 4. ë¡œë´‡ ë§ˆì»¤ (í´ë¦­ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì„¤ì •)
            robotMarker = new createjs.Container();
            var arrowBody = new createjs.Shape();
            arrowBody.graphics.beginFill("#ff4400").moveTo(0.35, 0).lineTo(-0.2, 0.25).lineTo(-0.1, 0).lineTo(-0.2, -0.25).closePath();
            robotMarker.addChild(arrowBody);
            robotMarker.scaleX = 0.03; robotMarker.scaleY = 0.03;
            robotMarker.mouseEnabled = false; // ë§ˆì»¤ í´ë¦­ ë¬´ì‹œ (ë°”ë‹¥ì„ í´ë¦­í•´ì•¼ í•¨)

            // 5. TF ìˆ˜ì‹ 
            var tfTopic = new ROSLIB.Topic({ ros: ros, name: '/tf', messageType: 'tf2_msgs/msg/TFMessage', latch: true });
            tfTopic.subscribe(function(msg) {
                msg.transforms.forEach(function(tf) {
                    var name = tf.child_frame_id.toLowerCase();
                    if (name.includes('link') || name.includes('footprint') || name.includes('base')) {
                        robotMarker.x = tf.transform.translation.x;
                        robotMarker.y = -tf.transform.translation.y;
                        var r = tf.transform.rotation;
                        var yaw = Math.atan2(2*(r.w*r.z+r.x*r.y), 1-2*(r.y*r.y+r.z*r.z));
                        robotMarker.rotation = -yaw * (180 / Math.PI); 
                        if (!viewer.scene.contains(robotMarker)) {
                            viewer.scene.addChild(robotMarker);
                            centerOnRobot();
                        }
                    }
                });
            });

            // 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì¤Œ/íŒ¬/í´ë¦­ í†µí•© ê´€ë¦¬)
            registerInteraction();

            // ì—°ê²° ìƒíƒœ í‘œì‹œ
            ros.on('connection', () => { document.getElementById('status-msg').innerText = "ğŸŸ¢ ì‹œìŠ¤í…œ ì˜¨ë¼ì¸"; });
            ros.on('error', (err) => { document.getElementById('status-msg').innerText = "ğŸ”´ ì—°ê²° ì‹¤íŒ¨ (ws server í™•ì¸)"; });
            ros.on('close', () => { document.getElementById('status-msg').innerText = "âšª ì—°ê²° ì¢…ë£Œ"; });
        }

        function registerInteraction() {
            var canvas = document.getElementById('map').querySelector('canvas');

            // [ê¸°ëŠ¥ 1] ë§ˆìš°ìŠ¤ íœ  ì¤Œ (Native)
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                var zoomFactor = 1.1;
                var local = viewer.scene.globalToLocal(e.offsetX, e.offsetY);
                if (e.deltaY < 0) { viewer.scene.scaleX *= zoomFactor; viewer.scene.scaleY *= zoomFactor; }
                else { viewer.scene.scaleX /= zoomFactor; viewer.scene.scaleY /= zoomFactor; }
                viewer.scene.x = e.offsetX - local.x * viewer.scene.scaleX;
                viewer.scene.y = e.offsetY - local.y * viewer.scene.scaleY;
            });

            // [ê¸°ëŠ¥ 2] ë§µ ì´ë™ (Native Mouse Events)
            var startPanX, startPanY;
            
            canvas.addEventListener('mousedown', function(e) {
                isPanning = false;
                startPanX = e.clientX;
                startPanY = e.clientY;
            });

            window.addEventListener('mousemove', function(e) {
                if (e.buttons === 1) { // ì™¼ìª½ ë²„íŠ¼ ëˆ„ë¥¸ ì±„ ì´ë™
                    var dx = e.clientX - startPanX;
                    var dy = e.clientY - startPanY;
                    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                        isPanning = true; // ì¡°ê¸ˆì´ë¼ë„ ì›€ì§ì´ë©´ íŒ¬ ëª¨ë“œë¡œ ê°„ì£¼
                        viewer.scene.x += dx;
                        viewer.scene.y += dy;
                        startPanX = e.clientX;
                        startPanY = e.clientY;
                    }
                }
            });

            // [ê¸°ëŠ¥ 3] ëª©ì ì§€ ì„¤ì • (CreateJS Stage Event)
            // íˆ¬ëª… ë°°ê²½íŒ ë•ë¶„ì— ì–´ë””ë¥¼ ëˆŒëŸ¬ë„ ì´ ì´ë²¤íŠ¸ê°€ ë°œìƒí•¨
            viewer.scene.addEventListener('stagemousedown', function(event) {
                clickStartX = event.stageX;
                clickStartY = event.stageY;
            });

            viewer.scene.addEventListener('stagemouseup', function(event) {
                // 1. íŒ¬(ë“œë˜ê·¸) ì¤‘ì´ì—ˆë‹¤ë©´ ëª©ì ì§€ ì„¤ì • ì•ˆí•¨
                if (isPanning) return;

                // 2. í´ë¦­ ì‹œì‘ì ê³¼ ëì  ì°¨ì´ê°€ í¬ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼ (ì†ë–¨ë¦¼ ë³´ì • 10px)
                var diffX = Math.abs(event.stageX - clickStartX);
                var diffY = Math.abs(event.stageY - clickStartY);
                if (diffX > 10 || diffY > 10) return;

                // 3. ì¢Œí‘œ ë³€í™˜ ë° ì „ì†¡
                var pos = viewer.scene.globalToLocal(event.stageX, event.stageY);
                console.log("ğŸ‘† í´ë¦­ ê°ì§€ë¨! ì¢Œí‘œ:", pos.x, -pos.y); // F12 ì½˜ì†” í™•ì¸ìš©

                if (currentMode === 'GOAL') sendGoal(pos.x, -pos.y);
                else sendInitialPose(pos.x, -pos.y);
            });
        }

        // --- ì´í•˜ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function centerOnRobot() {
            if (!robotMarker) return;
            viewer.scene.x = (viewer.width / 2) - (robotMarker.x * viewer.scene.scaleX);
            viewer.scene.y = (viewer.height / 2) - (-robotMarker.y * viewer.scene.scaleY);
        }

        function sendGoal(x, y) {
            isStopping = false;
            document.getElementById('status-msg').innerText = `ğŸš€ ì´ë™: [${x.toFixed(2)}, ${y.toFixed(2)}]`;
            var topic = new ROSLIB.Topic({ ros : ros, name : '/goal_pose', messageType : 'geometry_msgs/msg/PoseStamped' });
            var msg = new ROSLIB.Message({ header: { frame_id: "map" }, pose: { position: { x: x, y: y, z: 0 }, orientation: { w: 1.0 } } });
            topic.publish(msg);
        }

        function sendInitialPose(x, y) {
            var topic = new ROSLIB.Topic({ ros : ros, name : '/initialpose', messageType : 'geometry_msgs/msg/PoseWithCovarianceStamped' });
            var msg = new ROSLIB.Message({ header: { frame_id: "map" }, pose: { pose: { position: { x: x, y: y, z: 0 }, orientation: { w: 1.0 } }, covariance: [0.25, 0, 0, 0, 0, 0, 0, 0.25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.06] } });
            topic.publish(msg);
            setMode('GOAL');
            document.getElementById('status-msg').innerText = "ğŸ“ ìœ„ì¹˜ ë³´ì • ì™„ë£Œ";
        }

        function stopRobot() {
            isStopping = true; 
            document.getElementById('status-msg').innerText = "ğŸ›‘ ì •ì§€ ì¤‘...";
            sendGoal(robotMarker.x, -robotMarker.y); // í˜„ì¬ ìœ„ì¹˜ë¥¼ ëª©ì ì§€ë¡œ
            var cmdVel = new ROSLIB.Topic({ ros: ros, name: '/cmd_vel', messageType: 'geometry_msgs/msg/Twist' });
            var twist = new ROSLIB.Message({ linear: { x: 0, y: 0, z: 0 }, angular: { x: 0, y: 0, z: 0 } });
            var count = 0;
            var stopInterval = setInterval(() => { cmdVel.publish(twist); count++; if(count > 10) clearInterval(stopInterval); }, 50);
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-goal').className = (mode === 'GOAL' ? 'btn-mode active' : 'btn-mode');
            document.getElementById('btn-pose').className = (mode === 'POSE' ? 'btn-mode active' : 'btn-mode');
        }
    </script>
</head>
<body onload="init()">
    <div id="header">
        <div id="status-msg">ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</div>
        <div>MentorPi Mission Control (Fixed)</div>
    </div>
    <div id="map"></div>
    <div class="footer">
        <button id="btn-goal" class="btn-mode active" onclick="setMode('GOAL')">ğŸ¯ ëª©ì ì§€ ì„¤ì •</button>
        <button id="btn-pose" class="btn-mode" onclick="setMode('POSE')">ğŸ“ ìœ„ì¹˜ ë³´ì •</button>
        <button class="btn-red" onclick="stopRobot()">ğŸ›‘ ì¦‰ì‹œ ì •ì§€</button>
        <button class="btn-mode" onclick="centerOnRobot()">ğŸ” ë‚´ ë¡œë´‡ ì°¾ê¸°</button>
    </div>
</body>
</html>